{% extends "admin_base.html" %}

{% block content %}
<div class="container mx-auto px-4 sm:px-8 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-extrabold text-green-900">Student Management</h1>
        <div class="flex gap-4">
            <button data-action="add" data-item-type="student" class="bg-green-800 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">Add Student</button>
            <a href="{{ url_for('admin.bulk_upload', item_type='students') }}" class="bg-blue-800 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">Bulk Upload</a>
            <a href="{{ url_for('admin.manage_students', export='csv') }}" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-md">Export CSV</a>
        </div>
    </div>

    <!-- Filters -->
    <form method="POST" class="bg-green-100 shadow-md rounded-lg p-4 mb-6 flex items-center gap-4">
        <input type="text" name="search" placeholder="Search..." class="w-full rounded-full py-2 px-4 bg-white text-green-900 border-2 border-green-200 focus:outline-none focus:border-green-800">
        <select name="branch" class="rounded-lg py-2 px-4 bg-white text-green-900 border-2 border-green-200 focus:outline-none focus:border-green-800">
            <option value="">All Branches</option>
            <!-- Add branches dynamically if possible -->
        </select>
        <select name="section" class="rounded-lg py-2 px-4 bg-white text-green-900 border-2 border-green-200 focus:outline-none focus:border-green-800">
            <option value="">All Sections</option>
            <!-- Add sections dynamically -->
        </select>
        <select name="academic_year" class="rounded-lg py-2 px-4 bg-white text-green-900 border-2 border-green-200 focus:outline-none focus:border-green-800">
            <option value="">All Years</option>
            <!-- Add years dynamically -->
        </select>
        <button type="submit" class="bg-green-800 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">Filter</button>
    </form>

    <!-- Student Table -->
    <div id="students-container" class="bg-green-100 shadow-lg rounded-2xl overflow-hidden" data-students='{{ students | tojson | safe }}'>
        <table class="min-w-full leading-normal">
            <thead class="bg-green-800 text-white">
                <tr>
                    <th class="px-6 py-3 text-left">Image</th>
                    <th class="px-6 py-3 text-left">Name</th>
                    <th class="px-6 py-3 text-left">Roll Number</th>
                    <th class="px-6 py-3 text-left">Branch</th>
                    <th class="px-6 py-3 text-left">Academic Year</th>
                    <th class="px-6 py-3 text-left">Attendance</th>
                    <th class="px-6 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr class="border-b border-green-200 hover:bg-green-200">
                    <td class="px-6 py-4"><img src="{{ student.image_url or url_for('static', filename='default-avatar.png') }}" class="w-12 h-12 rounded-full object-cover"></td>
                    <td class="px-6 py-4">{{ student.name }}</td>
                    <td class="px-6 py-4">{{ student.roll_number }}</td>
                    <td class="px-6 py-4">{{ student.branch }}</td>
                     <td class="px-6 py-4">{{ student.academic_year~ '-'~ (student.academic_year | int + 4) if student.academic_year }}</td>
                    <td class="px-6 py-4">{{ student.attendance_percentage or 'N/A' }}%</td>
                    <td class="px-6 py-4 text-center">
                        <button data-action="edit" data-item-type="student" data-item-id="{{ student.id }}" class="text-green-700 hover:text-green-900">Edit</button>
                        <button data-action="delete" data-item-type="students" data-item-id="{{ student.id }}" class="text-red-600 hover:text-red-800 ml-4">Delete</button>
                        <form method="POST" action="{{ url_for('admin.reset_student_password', item_id=student.id) }}" style="display:inline" onsubmit="return confirm('Reset password to Hitam@123 for this student?');">
                            <button type="submit" class="text-blue-600 hover:text-blue-800 ml-4">Reset Password</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Student Modal -->
<div id="studentModal" class="fixed z-50 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen">
        <div class="fixed inset-0 bg-gray-800 bg-opacity-75"></div>
        <div class="bg-white rounded-lg shadow-2xl transform sm:max-w-4xl sm:w-full">
            <form id="studentForm" method="POST" enctype="multipart/form-data">
                <div class="px-6 py-4">
                    <h3 id="studentModalTitle" class="text-2xl font-bold text-green-900">Add New Student</h3>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Student Details -->
                        <div>
                            <h4 class="text-lg font-semibold mb-2">Student Information</h4>
                            <input type="text" name="name" placeholder="Full Name" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="email" name="email" placeholder="Email" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <!-- Password removed: default password will be assigned automatically -->
                            <input type="text" name="roll_number" placeholder="Roll Number" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="branch" placeholder="Branch" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="section" placeholder="Section" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="academic_year" placeholder="Academic Year (e.g., 2023-2027)" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="gender" placeholder="Gender" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="religion" placeholder="Religion" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="phone" placeholder="Phone" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                             <div>
                                <label for="image" class="block text-sm font-medium text-gray-700">Student Image</label>
                                <div class="mt-1 flex items-center">
                                    <img id="imagePreview" src="{{ url_for('static', filename='default-avatar.png') }}" class="w-16 h-16 rounded-full object-cover mr-4">
                                    <input type="file" name="image" id="image" class="w-full text-sm text-slate-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-green-50 file:text-green-700
                                        hover:file:bg-green-100
                                    "/>
                                </div>
                                 <input type="text" name="image_url" id="image_url" placeholder="Or enter image URL" class="w-full rounded-md border-gray-300 shadow-sm mt-2">
                            </div>
                        </div>
                        <!-- Parent Details -->
                        <div>
                            <h4 class="text-lg font-semibold mb-2">Parent 1 Information</h4>
                            <input type="text" name="parent1_name" placeholder="Parent 1 Name" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="email" name="parent1_email" placeholder="Parent 1 Email" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="parent1_phone" placeholder="Parent 1 Phone" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            
                            <h4 class="text-lg font-semibold mb-2">Parent 2 Information</h4>
                            <input type="text" name="parent2_name" placeholder="Parent 2 Name" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="email" name="parent2_email" placeholder="Parent 2 Email" class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                            <input type="text" name="parent2_phone" placeholder="Parent 2 Phone" class="w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 px-6 py-4 flex justify-end gap-4">
                    <button type="button" data-action="close-modal" data-modal-id="studentModal" class="py-2 px-6 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="py-2 px-6 bg-green-800 text-white rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div id="deleteConfirmationModal" class="fixed z-50 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen">
        <div class="fixed inset-0 bg-gray-800 bg-opacity-75"></div>
        <div class="bg-white rounded-lg shadow-2xl transform sm:max-w-md sm:w-full">
            <form id="deleteForm" method="POST">
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-red-800">Confirm Deletion</h3>
                    <p class="mt-2">Are you sure you want to delete this item? This action is permanent.</p>
                </div>
                <div class="bg-gray-100 px-6 py-4 flex justify-end gap-4">
                    <button type="button" data-action="close-modal" data-modal-id="deleteConfirmationModal" class="py-2 px-6 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class.="py-2 px-6 bg-red-700 text-white rounded-lg">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentsContainer = document.getElementById('students-container');
    const studentsData = JSON.parse(studentsContainer.dataset.students || '[]');
    const studentsMap = new Map(studentsData.map(s => [s.id, s]));

    const studentModal = document.getElementById('studentModal');
    const studentForm = document.getElementById('studentForm');
    const studentModalTitle = document.getElementById('studentModalTitle');
    const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');

    function openModal(modal) { modal.classList.remove('hidden'); }
    function closeModal(modal) { modal.classList.add('hidden'); }

    function openAddModal() {
        studentModalTitle.innerText = 'Add New Student';
        studentForm.action = "{{ url_for('admin.add_user', role='student') }}";
        studentForm.reset();
        document.getElementById('imagePreview').src = "{{ url_for('static', filename='default-avatar.png') }}";
        if (studentForm.elements.password) {
            studentForm.elements.password.placeholder = "Password (required)";
            studentForm.elements.password.required = true;
        }
        openModal(studentModal);
    }

    function openEditModal(studentId) {
        const student = studentsMap.get(studentId);
        if (!student) return;

        studentModalTitle.innerText = 'Edit Student';
        studentForm.action = `/admin/edit/student/${student.id}`;
        studentForm.reset();

        for (const key in student) {
            if (studentForm.elements[key]) {
                studentForm.elements[key].value = student[key] || '';
            }
        }

        // Overwrite academic_year with the formatted range
        if (student.academic_year) {
            const startYear = parseInt(student.academic_year, 10);
            if (!isNaN(startYear)) {
                studentForm.elements.academic_year.value = `${startYear}-${startYear + 4}`;
            }
        }

        // Handle nested parent data
        if (student.parents) {
            student.parents.forEach((parent, index) => {
                const parentIndex = index + 1;
                if (studentForm.elements[`parent${parentIndex}_name`]) {
                    studentForm.elements[`parent${parentIndex}_name`].value = parent.name || '';
                    studentForm.elements[`parent${parentIndex}_email`].value = parent.email || '';
                    studentForm.elements[`parent${parentIndex}_phone`].value = parent.phone || '';
                }
            });
        }
        
        document.getElementById('imagePreview').src = student.image_url || "{{ url_for('static', filename='default-avatar.png') }}";
        studentForm.elements.image_url.value = student.image_url || '';
        if (studentForm.elements.password) {
            studentForm.elements.password.placeholder = "New password (optional)";
            studentForm.elements.password.required = false;
        }

        openModal(studentModal);
    }

    function openDeleteModal(itemType, itemId) {
        const form = document.getElementById('deleteForm');
        form.action = `/admin/delete/${itemType}/${itemId}`;
        openModal(deleteConfirmationModal);
    }
    
    document.getElementById('image').addEventListener('change', function(event) {
        if (event.target.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { document.getElementById('imagePreview').src = e.target.result; };
            reader.readAsDataURL(event.target.files[0]);
        }
    });

    document.body.addEventListener('click', function(event) {
        const target = event.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const itemId = target.dataset.itemId;
        const itemType = target.dataset.itemType;

        if (action === 'add' && itemType === 'student') {
            openAddModal();
        } else if (action === 'edit' && itemType === 'student') {
            openEditModal(itemId);
        } else if (action === 'delete') {
            openDeleteModal(itemType, itemId);
        } else if (action === 'close-modal') {
            closeModal(document.getElementById(target.dataset.modalId));
        }
    });
});
</script>
{% endblock %}
